'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';

// Carga dinámica de react-leaflet sólo en cliente para evitar errores de SSR
type RLType = typeof import('react-leaflet') | null;

export default function TagPage({
  params,
}: {
  params: { id: string };
}) {
  const id = params?.id || 'demo';

  // Estado de "modo perdido"
  const [lostMode, setLostMode] = useState(false);
  const [lostNote, setLostNote] = useState('“¡Encontrado, por favor contacta ahora!”');

  // Geolocalización del último escaneo
  const [lat, setLat] = useState<number | null>(null);
  const [lng, setLng] = useState<number | null>(null);

  // Carga perezosa de React Leaflet + CSS de Leaflet
  const [RL, setRL] = useState<RLType>(null);
  useEffect(() => {
    (async () => {
      if (typeof window === 'undefined') return;
      const rl = await import('react-leaflet');
      await import('leaflet/dist/leaflet.css');
      setRL(rl);
    })();
  }, []);

  // Simular/registrar escaneo: usa geolocalización
  const handleRegisterScan = () => {
    if (!navigator.geolocation) {
      alert('Este dispositivo no permite obtener ubicación.');
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        setLat(pos.coords.latitude);
        setLng(pos.coords.longitude);
        alert('¡Escaneo registrado!');
      },
      () => alert('No se pudo obtener la ubicación. Activa permisos de GPS.')
    );
  };

  // Enlaces externos con coordenadas
  const gmaps = lat && lng ? `https://www.google.com/maps?q=${lat},${lng}` : '#';
  const waze  = lat && lng ? `https://waze.com/ul?ll=${lat}%2C${lng}&navigate=yes` : '#';

  // WhatsApp (mensaje con ubicación si existe)
  const ownerPhone = ''; // Ejemplo: '50370000000' (sin + ni espacios). Déjalo vacío si solo quieres compartir texto
  const waText = encodeURIComponent(
    lat && lng
      ? `Ubicación del escaneo:\nhttps://www.google.com/maps?q=${lat},${lng}`
      : `Escaneo realizado de la placa ID: ${id}`
  );
  const waHref = ownerPhone
    ? `https://wa.me/${ownerPhone}?text=${waText}`
    : `https://wa.me/?text=${waText}`;

  return (
    <main>
      <div className="grid">
        {/* Columna izquierda: Ficha */}
        <section className="card">
          <h2>Ficha de Identificación</h2>

          <p><strong>Nombre:</strong> Milo</p>
          <p><strong>Especie:</strong> Canino</p>
          <p><strong>Raza:</strong> Mestizo</p>
          <p><strong>Color:</strong> Blanco y café</p>
          <p><strong>Contacto:</strong> Óscar — +503 7000 0000</p>
          <p><strong>Notas:</strong> Amigable. Usa collar celeste.</p>

          <div className="actions" style={{ marginTop: 8 }}>
            {/* Botón principal en ROJO */}
            <button
              className="btn btn-warning"
              onClick={() => setLostMode((v) => !v)}
            >
              {lostMode ? 'Desactivar Modo Perdido' : 'Activar Modo Perdido'}
            </button>
          </div>

          {/* Aviso de modo perdido */}
          {lostMode && (
            <div className="lost-info" style={{ marginTop: 18 }}>
              <h3>¡Placa en Modo Perdido!</h3>
              <p><strong>Contacta a:</strong> +503 7000 0000 (Óscar)</p>
              <p><strong>Nota:</strong> {lostNote}</p>
            </div>
          )}

          <h3 style={{ marginTop: 24 }}>Bitácora de escaneos</h3>
          <div className="actions">
            {/* ROJO */}
            <button className="btn btn-primary" onClick={handleRegisterScan}>
              Registrar escaneo
            </button>

            {/* WHATSAPP VERDE */}
            <a
              className="btn btn-wa"
              href={waHref}
              target="_blank"
              rel="noopener noreferrer"
              aria-disabled={!lat || !lng}
              title={!lat || !lng ? 'Registra un escaneo para adjuntar la ubicación' : 'Compartir por WhatsApp'}
            >
              Compartir ubicación por WhatsApp
            </a>

            {/* SECUNDARIOS (outline) */}
            <a
              className="btn btn-outline"
              href={gmaps}
              target="_blank"
              rel="noopener noreferrer"
              aria-disabled={!lat || !lng}
            >
              Abrir en Google Maps
            </a>

            <a
              className="btn btn-outline"
              href={waze}
              target="_blank"
              rel="noopener noreferrer"
              aria-disabled={!lat || !lng}
            >
              Abrir en Waze
            </a>

            <Link href="/" className="btn btn-outline">
              Inicio
            </Link>
          </div>

          {/* Mapa de último escaneo (solo si RL está cargado y hay coordenadas) */}
          {RL && lat && lng && (
            <div style={{ marginTop: 20 }}>
              <h4>Ubicación del último escaneo:</h4>
              <RL.MapContainer
                center={[lat, lng]}
                zoom={13}
                style={{ width: '100%', height: '400px' }}
              >
                <RL.TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
                <RL.Marker position={[lat, lng]}>
                  <RL.Popup>Escaneo realizado en {lat}, {lng}</RL.Popup>
                </RL.Marker>
              </RL.MapContainer>
            </div>
          )}
        </section>

        {/* Columna derecha: ayuda */}
        <aside className="card">
          <h3>¿Qué es esto?</h3>
          <p>
            Quien escanee la placa verá esta ficha y podrá contactarte.
          </p>
          <p className="muted">
            Demo usando ID: <code>demo</code>
          </p>
        </aside>
      </div>
    </main>
  );
}
